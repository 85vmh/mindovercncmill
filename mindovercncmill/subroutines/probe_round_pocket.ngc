(author: Vasi Mihalca)
(version: 0.1)
(date: 20/01/2021)

(Probe round pocket center measure x and y Diam, find xy center position)
(Start probe position is the aproximated center of the pocket)
(inside the step off width distance and within max z distance)
(ensure all settings have been set properly according to help diagrams)

o<probe_round_pocket> sub

  (uses NGCGUI style arg spec)
  (number after "=" in comment is default value)
  #<setting_probe_tool_number> = #1    (=99)
  #<setting_probe_fast_fr> = #2        (=200.0)
  #<setting_probe_slow_fr> = #3        (=20.0)
  #<setting_latch_distance> = #4       (=0.5)
  #<setting_probe_mode> = #5           (=0)
  #<setting_calibration_offset> = #6   (=0)

  #<input_max_z_distance> = #7        (=10.000)
  #<input_max_xy_distance> = #8      (=0.5000)
  #<input_step_off_width> = #9      (=0.5000)
  #<input_diameter_hint> = #10          (=0.5000)

  (Cancel G92 offsets)
  G92.1

  #<workspace_x> = #[5201 + [20 * #5220]]
  #<workspace_y> = #[5202 + [20 * #5220]]

  (Probe Tool Safety Check)
  o<110> if [#5400 NE #<setting_probe_tool_number>]
  (ERROR, Probe tool in the spindle, aborting)
   o<probe_round_pocket> return
  o<110> endif

  (Probe Diameter)
  #<probe_diameter> = #5410

  (remove probe tip diam and cal offset from probed width calculations)
  #<probe_diameter_offset> = [#<probe_diameter> - [#<setting_calibration_offset> * 2]]

  (Move to probing depth)
  G91
  F[#<setting_probe_fast_fr>]
  G38.3 Z-[#<input_max_z_distance>]

  G91
   (Move to the left side of the hole)
  F[#<setting_probe_fast_fr>]
  G38.3 X-[[#<input_diameter_hint> / 2] - [#<input_step_off_width>]]

  (Call sub "probe_x_minux" to Probe x- side of Hole)
  o<probe_x_minus> call [#2] [#3] [#4] [#6] [#8] [#9]

  #<x_minus_probed> = #5061

  G91
  (Move to the right side of the hole)
  F[#<setting_probe_fast_fr>]
  G38.3 X[#<input_diameter_hint> - [2* #<input_step_off_width>]]

  (Call sub "probe_x_plus" to Probe x+)
  o<probe_x_plus> call [#2] [#3] [#4] [#6] [#8] [#9]

  #<x_plus_probed> = #5061

  (probed center calculation)
  #<x_center_probed> = [[#<x_plus_probed> + #<x_minus_probed>] / 2]

  (move to center of X)
  G90
  F[#<setting_probe_fast_fr>]
  G38.3 X[#<x_center_probed>]

  G91
  (Move to the back side of the hole)
  F[#<setting_probe_fast_fr>]
  G38.3 Y[#<input_diameter_hint> - [2* #<input_step_off_width>]]

  (Call sub "probe_y_plus" to Probe y+ side of Workpiece)
  o<probe_y_plus> call [#2] [#3] [#4] [#6] [#8] [#9]

  #<y_plus_probed> = #5062

  G91
  (Move to the front side of the hole)
  F[#<setting_probe_fast_fr>]
  G38.3 Y-[#<input_diameter_hint> - [2* #<input_step_off_width>]]

  (Call sub "probe_y_minus" to Probe y- side of Workpiece)
  o<probe_y_minus> call [#2] [#3] [#4] [#6] [#8] [#9]

  #<y_minus_probed> = #5062

  (probed center calulation)
  #<y_center_probed> = [[#<y_minus_probed> + #<y_plus_probed>] / 2]

  (Move to Y Center)
  G90
  F[#<setting_probe_fast_fr>]
  G38.3 Y[#<y_center_probed>]

  (Retract Z axis to the starting point)
  G91
  F[#<setting_probe_fast_fr>]
  G0 Z[#<input_max_z_distance>]


  (calculate X Width Probed)
  o<120> if [#<x_minus_probed> GT #<x_plus_probed>]
    #<x_raw_width> = [#<x_minus_probed> - #<x_plus_probed>]
  o<120> else
    #<x_raw_width> = [#<x_plus_probed> - #<x_minus_probed>]
  o<120> endif

  (Completed probed width calculations)
  #<x_probed_width> = [#<x_raw_width> - #<probe_diameter_offset>]

  (calculate Y Width Probed)
  o<130> if [#<y_minus_probed> GT #<y_plus_probed>]
    #<y_raw_width> = [#<y_minus_probed> - #<y_plus_probed>]
  o<130> else
    #<y_raw_width> = [#<y_plus_probed> - #<y_minus_probed>]
  o<130> endif

  (Completed probed width calculations)
  #<y_probed_width> = [#<y_raw_width> - #<probe_diameter_offset>]

  #<averaged_diameter> = [[#<x_probed_width> + #<y_probed_width>] / 2]

  (Output to probewizardwidget")
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayXMinus{#<x_minus_probed>}])
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayXCenter{#<x_center_probed>}])
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayXPlus{#<x_plus_probed>}])
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayXWidth{#<x_probed_width>}])

  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayYMinus{#<y_minus_probed>}])
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayYCenter{#<y_center_probed>}])
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayYPlus{#<y_plus_probed>}]) 
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayYWidth{#<y_probed_width>}]) 

  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayDiameter{#<averaged_diameter>}]) 

  #<x_zero> = [#<x_center_probed> + #<workspace_x>]
  #<y_zero> = [#<y_center_probed> + #<workspace_y>]

  (probe mode rules for WCO or probe position measuring only)
  o<140> if [#<setting_probe_mode> EQ 0]
    (Record XY Zero in selected WCO)
    G10 L2 P#5220 X[#<x_zero>] Y[#<y_zero>]
    o<probe_round_pocket> return
  o<140> endif

o<probe_round_pocket> endsub

M2 (end program)
