(author: Chris P)
(version: 0.1)
(date: 04/25/19)

(Probe Y Minus direction to locate edge, end at clearance distance)
(Start probe position to the back side edge of stock)
(inside the max xy distance with the probe tip below the stock top edge)
(ensure all settings have been set properly according to help diagrams)

o<probe_y_minus> sub

  (uses NGCGUI style arg spec)
  (number after "=" in comment is default value)

  #<setting_probe_tool_number> = #1    (=99)
  #<setting_probe_fast_fr> = #2        (=200.0)
  #<setting_probe_slow_fr> = #3        (=20.0)
  #<setting_latch_distance> = #4       (=0.5)
  #<setting_probe_mode> = #5           (=0)
  #<setting_calibration_offset> = #6   (=0)

  #<input_max_z_distance> = #7        (=10.000)
  #<input_z_final_retract> = #8       (=0.1000)
  #<input_max_xy_distance> = #9      (=0.5000)

  (Cancel G92 offsets)
  G92.1

  #<workspace_y> = #[5202 + [20 * #5220]]

  (Probe Tool Safety Check)
  o<110> if [#5400 NE #<setting_probe_tool_number>]
  (ERROR, Probe tool in the spindle, aborting)
   o<probe_y_minus> return
  o<110> endif

  (Probe Diameter)
  #<probe_diameter> = #5410

  (Probe Radius)
  #<probe_radius> = [#<probe_diameter> / 2]

  (Probe Centerline Offset)
  #<probe_center_offset> = [#<probe_radius> - #<setting_calibration_offset>]

  (Current Y Position including offsets in current program units)
  #<y> = #5421

  (Initiate Fast Y- Probe)
  G91
  F[#<setting_probe_fast_fr>]

  G1 Y[#<input_max_xy_distance>]
  G1 Z-[#<input_max_z_distance>]

  G38.2 Y-[#<input_max_xy_distance>]
  #<y_minus_probed> = #5062

  (Probe Error check, #5070 will be 0 if failed)
  o<120> if [#5070 EQ 0]
    (back to start point and feed)
    G90
    G0 Y#<y>
    F[#<setting_probe_fast_fr>]
    (return from sub)
    o<probe_y_minus> return
  o<120> endif

  (Move to setting_latch_distance distance for slow probe)
  G90
  G0 Y[#<y_minus_probed> + #<setting_latch_distance>]


  (Initiate Slow Y- Probe)
  G91
  F[#<setting_probe_slow_fr>]
  G38.2 Y-[#<setting_latch_distance> * 2]
  #<y_minus_probed> = #5062
  (debug, Probed Pos: #5062 , Y Pos: #<_y>)
  G90
  G0 Y[#<y_minus_probed> + #<input_max_xy_distance>]

  G91
  G0 Z[#<input_max_z_distance>]

  #<y_minus_zero_edge> = [#<y_minus_probed> - #<probe_center_offset>]

  G90
  G0 Y[#<y_minus_zero_edge>]

  (Output to probewizardwidget")
  (DEBUG, EVAL[vcp.getWidget{"probewizardwidget"}.displayYMinus{#<y_minus_probed>}])

  (probe mode rule for WCO or probe position measuring only)
  o<140> if [#<setting_probe_mode> EQ 0]
    (Record X Zero in selected WCO)
    G10 L2 P#5220 Y[#<y_minus_zero_edge> + #<workspace_y>]
    o<probe_y_minus> return
  o<140> endif
  
o<probe_y_minus> endsub

M2 (end program)
