o<tool_touch_off> sub

#<y_offset_amount> = #1    (adds an offset on the Y axis)

G92.1 (Cancel G92 offsets)

#<workspace_z> = #5220
G59.3 (change coordinate system)

G49 (Cancel Tool Length Compensation)

G90   (set absolute coordinates)
G53 G0 Z[#<_ini[CHANGE_POSITION]Z>]

G53 G0 X[#<_hal[mindovercnc.tool-probe.x-coordinate]>] Y[#<_hal[mindovercnc.tool-probe.y-coordinate]> + #<y_offset_amount>]
G53 G0 Z[#<_hal[mindovercnc.tool-probe.z-coordinate]>]

(Initiate Fast Z- Probe)
G91
F [#<_hal[mindovercnc.tool-probe.fast-probe-rate]>]
G38.2 Z [#<_hal[mindovercnc.tool-probe.max-z-travel]>]
(Retract before starting the slow probing)
G0 Z [#<_hal[mindovercnc.tool-probe.retract-distance]>]

(Initiate Slow Z- Probe)
G91
F [#<_hal[mindovercnc.tool-probe.slow-probe-rate]>]
(Probe down max 2x retract-distance)
G38.2 Z -[#<_hal[mindovercnc.tool-probe.retract-distance]> * 2] 

G90
(Raise the Z up)
G53 G0 Z[#<_ini[CHANGE_POSITION]Z>]

o<130> if [#5070 EQ 1]    (verify probe event was succesful)
  #<touch_result> = #5063    (save slow probe result to parameters)
o<130> else
  (MSG,Tool Length Offset Probe Failed)
o<130> endif


#<spindle_nose> = #<_hal[mindovercnc.tool-probe.from-spindle-nose]>

(define new tool length offset parameters)
#<new_tool_length_offset> = [ABS[#<spindle_nose> + #<touch_result>]]

(debug, Touch Result: #<touch_result>)
(debug, Spindle Nose: #<spindle_nose>)
(debug, Length Offset: #<new_tool_length_offset>)

(#5400 = tool number)
#<tool> = #5400
G10 L1 P#<tool> Z[#<new_tool_length_offset>]

o<160> if [#<workspace_z> EQ 1]
  G54
o<160> else if [#<workspace_z> EQ 2]
  G55
o<160> else if [#<workspace_z> EQ 3]
  G56
o<160> else if [#<workspace_z> EQ 4]
  G57
o<160> else if [#<workspace_z> EQ 5]
  G58
o<160> else if [#<workspace_z> EQ 6]
  G59
o<160> else if [#<workspace_z> EQ 7]
  G59.1
o<160> else if [#<workspace_z> EQ 8]
  G59.2
o<160> endif

T #<tool> G43  H #<tool> (enable tool length offset) 

o<tool_touch_off> endsub

M2 (end program)
